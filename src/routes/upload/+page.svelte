<script lang="ts">
	import { onMount } from 'svelte';
	import { goto } from '$app/navigation';
	import { uploadFile, getAlbums } from '$lib/upload';
	import { supabase } from '$lib/supabase/client';
	import { getCoupleStatus } from '$lib/couple';
	
	let albums: any[] = [];
	let selectedAlbum = '';
	let caption = '';
	let selectedFile: File | null = null;
	let previewUrl = '';
	let uploading = false;
	let uploadMessage = '';
	let uploadError = '';
	let authLoading = true;
	let user: any = null;
	let coupleStatus: any = null;
	
	onMount(async () => {
		// Check authentication first
		await checkAuthentication();
		
		// Only proceed if user is authenticated and has active couple
		if (!user || !coupleStatus?.isActive) {
			return;
		}
		
		try {
			albums = await getAlbums();
			if (albums.length > 0) {
				selectedAlbum = albums[0].id;
			}
		} catch (error) {
			console.error('Error loading albums:', error);
			uploadError = 'Failed to load albums. Please try again.';
		}
	});
	
	async function checkAuthentication() {
		try {
			authLoading = true;
			const { data: { session }, error } = await supabase.auth.getSession();
			
			if (error || !session || !session.user) {
				goto('/auth');
				return;
			}
			
			user = session.user;
			
			// Check couple status
			coupleStatus = await getCoupleStatus();
			
			// If no couple or couple is pending, redirect to couple setup
			if (!coupleStatus?.hasCouple || coupleStatus?.isPending) {
				goto('/couple');
				return;
			}
			
			// If couple is not active, redirect to couple setup
			if (!coupleStatus?.isActive) {
				goto('/couple');
				return;
			}
			
		} catch (err) {
			console.error('Authentication check failed:', err);
			goto('/auth');
		} finally {
			authLoading = false;
		}
	}
	
	function handleFileSelect(event: Event) {
		const target = event.target as HTMLInputElement;
		const file = target.files?.[0];
		if (file) {
			selectedFile = file;
			previewUrl = URL.createObjectURL(file);
			uploadError = '';
		}
	}
	
	function handleDrop(event: DragEvent) {
		event.preventDefault();
		const file = event.dataTransfer?.files[0];
		if (file) {
			selectedFile = file;
			previewUrl = URL.createObjectURL(file);
			uploadError = '';
		}
	}
	
	function handleDragOver(event: DragEvent) {
		event.preventDefault();
	}
	
	async function handleUpload() {
		if (!selectedFile || !selectedAlbum) {
			uploadError = 'Please select a file and an album.';
			return;
		}
		
		uploading = true;
		uploadMessage = '';
		uploadError = '';
		
		try {
			await uploadFile(selectedFile, selectedAlbum, caption || undefined);
			uploadMessage = 'Upload successful!';
			
			// Add to timeline with base64 image
			const reader = new FileReader();
			reader.onload = (e) => {
				const newMemory = {
					id: Date.now(),
					media_url: e.target?.result as string, // Base64 data URL
					caption: caption || '',
					created_at: new Date().toISOString(),
					albums: { title: albums.find(a => a.id === selectedAlbum)?.title || 'New Album' }
				};
				
				// Save to localStorage
				const savedAlbums = localStorage.getItem('uploadedAlbums');
				const timelineAlbums = savedAlbums ? JSON.parse(savedAlbums) : [];
				timelineAlbums.unshift(newMemory);
				localStorage.setItem('uploadedAlbums', JSON.stringify(timelineAlbums));
				
				// Refresh timeline on home page
				if (typeof window !== 'undefined' && (window as any).refreshTimeline) {
					setTimeout(() => {
						(window as any).refreshTimeline();
					}, 1000);
				}
			};
			reader.readAsDataURL(selectedFile);
			
			selectedFile = null;
			previewUrl = '';
			caption = '';
			
			// Refresh timeline on home page
			if (typeof window !== 'undefined' && (window as any).refreshTimeline) {
				setTimeout(() => {
					(window as any).refreshTimeline();
				}, 1000);
			}
		} catch (error) {
			console.error('Upload error:', error);
			uploadError = error instanceof Error ? error.message : 'Failed to upload file.';
		} finally {
			uploading = false;
		}
	}
</script>

<svelte:head>
	<title>Upload - Love Timeline</title>
</svelte:head>

{#if authLoading}
	<!-- Authentication Loading State -->
	<div class="min-h-screen bg-gradient-to-br from-rose-50 via-pink-50 to-fuchsia-50 flex items-center justify-center">
		<div class="text-center">
			<div class="animate-spin rounded-full h-16 w-16 border-b-2 border-rose-500 mx-auto mb-6"></div>
			<h2 class="text-2xl font-bold text-gray-700 mb-2">Đang kiểm tra đăng nhập...</h2>
			<p class="text-gray-600">Vui lòng chờ trong giây lát</p>
		</div>
	</div>
{:else if !user || !coupleStatus?.isActive}
	<!-- Redirect to login or couple setup -->
	<div class="min-h-screen bg-gradient-to-br from-rose-50 via-pink-50 to-fuchsia-50 flex items-center justify-center">
		<div class="text-center">
			<div class="text-6xl mb-6">🔒</div>
			<h2 class="text-2xl font-bold text-gray-700 mb-2">Chưa đăng nhập hoặc chưa có couple</h2>
			<p class="text-gray-600 mb-6">Vui lòng đăng nhập và setup couple để upload memories</p>
			<a href="/couple" class="inline-block bg-gradient-to-r from-rose-500 to-pink-500 hover:from-rose-600 hover:to-pink-600 text-white px-8 py-3 rounded-2xl font-semibold text-lg transition-all duration-300 shadow-xl hover:shadow-2xl transform hover:scale-105">
				Setup Couple 💕
			</a>
		</div>
	</div>
{:else}
	<!-- Main Upload Content -->
<div class="container mx-auto px-4 py-8">
	<div class="text-center mb-8">
		<h1 class="text-3xl font-bold text-pink-600 mb-2">📸 Upload New Memory</h1>
		<p class="text-gray-600">Share your special moments with your loved one.</p>
	</div>

	<div class="max-w-2xl mx-auto bg-white/90 backdrop-blur rounded-3xl shadow-lg p-8">
		<form on:submit|preventDefault={handleUpload} class="space-y-6">
			<!-- File Dropzone -->
			<div
				class="border-2 border-dashed border-pink-300 rounded-2xl p-8 text-center cursor-pointer hover:border-pink-400 transition-colors duration-200"
				on:drop={handleDrop}
				on:dragover={handleDragOver}
				on:click={() => document.getElementById('fileInput')?.click()}
				role="button"
				tabindex="0"
			>
				<input type="file" id="fileInput" class="hidden" on:change={handleFileSelect} accept="image/*,video/*" />
				{#if previewUrl}
					<img src={previewUrl} alt="Preview" class="max-h-64 object-contain mx-auto mb-4 rounded-lg" />
					<p class="text-gray-700 font-medium">{selectedFile?.name}</p>
				{:else}
					<div class="text-6xl mb-4">⬆️</div>
					<p class="text-gray-700 font-medium mb-2">Drag & drop your photo/video here</p>
					<p class="text-gray-500 text-sm">or click to browse</p>
				{/if}
			</div>

			<!-- Album Selection -->
			<div>
				<label for="albumSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Album</label>
				<select
					id="albumSelect"
					bind:value={selectedAlbum}
					class="w-full px-4 py-3 rounded-2xl border border-gray-200 focus:border-pink-300 focus:ring-2 focus:ring-pink-100 transition-colors duration-200 bg-white/80 backdrop-blur"
					required
				>
					{#each albums as album}
						<option value={album.id}>{album.title}</option>
					{/each}
				</select>
			</div>

			<!-- Caption -->
			<div>
				<label for="captionInput" class="block text-sm font-medium text-gray-700 mb-2">Caption (Optional)</label>
				<input
					id="captionInput"
					bind:value={caption}
					placeholder="Add a sweet caption..."
					type="text"
					class="w-full px-4 py-3 rounded-2xl border border-gray-200 focus:border-pink-300 focus:ring-2 focus:ring-pink-100 transition-colors duration-200 bg-white/80 backdrop-blur"
				/>
			</div>

			{#if uploadError}
				<div class="p-3 bg-red-50 border border-red-200 rounded-2xl">
					<p class="text-red-700 text-sm">⚠️ {uploadError}</p>
				</div>
			{/if}

			{#if uploadMessage}
				<div class="p-3 bg-green-50 border border-green-200 rounded-2xl">
					<p class="text-green-700 text-sm">✅ {uploadMessage}</p>
				</div>
			{/if}

			<button
				type="submit"
				disabled={uploading || !selectedFile || !selectedAlbum}
				class="w-full bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white px-6 py-3 rounded-2xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
			>
				{uploading ? 'Uploading...' : 'Upload Memory'}
			</button>
		</form>
	</div>
</div>
{/if}